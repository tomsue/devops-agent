FROM quay.io/centos/centos:stream9
# 切换到 root 用户执行需要 root 权限的操作
USER root
RUN yum install -y sudo
ADD daemon.json /etc/docker/daemon.json

ENV LANG en_US.UTF-8
ENV LANGUAGE en_US:en
ENV LC_ALL en_US.UTF-8
# utils
# 安装必要的软件包和工具
RUN yum clean all && \
    yum makecache && \
    yum update -y && \
    yum install -y epel-release ca-certificates \
    unzip which make wget zip bzip2 gcc gcc-c++ curl-devel autoconf expat-devel \
    gettext-devel openssl-devel perl-devel zlib-devel python-pip java-1.8.0-openjdk && \
    yum -y install git && \
    git version && \
    yum -y clean all --enablerepo='*'
RUN yum install -y git && \
    git version


# USER jenkins
WORKDIR /home/jenkins

ENV SONAR_SCANNER_VERSION 4.8.0.2856

RUN curl -o sonar_scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux.zip && \
    unzip sonar_scanner.zip && rm sonar_scanner.zip \
    && rm -rf sonar-scanner-$SONAR_SCANNER_VERSION-linux/jre && \
    sed -i 's/use_embedded_jre=true/use_embedded_jre=false/g' /home/jenkins/sonar-scanner-$SONAR_SCANNER_VERSION-linux/bin/sonar-scanner && \
    mv /home/jenkins/sonar-scanner-$SONAR_SCANNER_VERSION-linux /usr/bin

ENV PATH $PATH:/usr/bin/sonar-scanner-$SONAR_SCANNER_VERSION-linux/bin

COPY ./ ./

ENV EXCLUDE_DOCKER 1
#RUN ./hack/install_utils.sh && rm -rf ./*

# Install podman
#RUN curl -L -o /etc/yum.repos.d/devel:kubic:libcontainers:stable.repo https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/CentOS_7/devel:kubic:libcontainers:stable.repo && \
#    yum -y install podman fuse-overlayfs && \
#    ln -s /usr/bin/podman /usr/bin/docker && \
#    yum -y clean all --enablerepo='*'
RUN yum -y install podman fuse-overlayfs && \
    ln -s /usr/bin/podman /usr/bin/docker && \
    yum -y clean all --enablerepo='*'

COPY storage.conf /etc/containers/storage.conf
COPY containers.conf /etc/containers/containers.conf

VOLUME /var/lib/containers
CMD ["podman", "info"]
